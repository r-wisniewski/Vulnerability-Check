import requests
import json
import pandas as pd
import time
from tqdm import tqdm

URL = "https://services.nvd.nist.gov/rest/json/cves/1.0/?cpeMatchString="
cpeMatchString = "cpe:2.3:a:*:"
append = ":*:*:*:*:*:*:*"

def nvd_check(pkg_dict) -> pd.DataFrame:
    rows_list = []
    count = 0
    bar = tqdm(desc="Progress",total=len(pkg_dict))
    for pkg in pkg_dict:
        count += 1
        prod = pkg
        ver = pkg_dict[pkg]

        #GET the vulnerabilities for this pkg + ver
        cpeArg = URL+cpeMatchString+prod+":"+ver+append
        resp = requests.get(cpeArg)
        # if we receive a 502 error, wait and try again
        if resp.status_code == 502:
            time.sleep(1)
            resp = requests.get(cpeArg)
        json_data = json.loads(resp.text)
        #If no CPE results were returned, then skip this pkg
        if json_data["totalResults"] == 0:
            pass
        else:
            vulnerabilities = json_data['result']['CVE_Items']
            #loop through matching vulnerabilities and build the pandas dataframe that will be returned
            for vuln in vulnerabilities:
                vuln_dict = {}
                #add entries to the vuln_dict for ["Package","Version"]
                vuln_dict["Package"] = prod
                vuln_dict["Version"] = ver
                vuln_dict["CVE ID"] = vuln['cve']['CVE_data_meta']['ID']
                #Use CVSS 3.x Severity and Metrics where possible, use 2.0 if 3.x doesn't exist
                try:
                    vuln_dict["Severity"] = vuln['impact']['baseMetricV3']['cvssV3']['baseSeverity']
                    vuln_dict["Score"] = vuln['impact']['baseMetricV3']['cvssV3']['baseScore']
                except:
                    vuln_dict["Severity"] = vuln['impact']['baseMetricV2']['severity']
                    vuln_dict["Score"] = vuln['impact']['baseMetricV2']['cvssV2']['baseScore']
                vuln_dict["Description"] = vuln['cve']['description']['description_data'][0]['value']
                vuln_dict["CWE ID"] = vuln['cve']['problemtype']['problemtype_data'][0]['description'][0]['value']
                vuln_dict["National Vulnerability Database Link"] = "https://nvd.nist.gov/vuln/detail/"+vuln['cve']['CVE_data_meta']['ID']
                #append the vuln_dict to the list of rows
                rows_list.append(vuln_dict)
        bar.update(1)
    bar.close()
    #build the pandas dataframe
    vuln_dataframe = pd.DataFrame(rows_list, columns=["Package","Version", "CVE ID", "Severity", "Score", "Description", "CWE ID", "National Vulnerability Database Link"])
    
    #return pandas dataframe with vulnerabilities of this system        
    return vuln_dataframe